name: manifold

services:
  # ─── Supabase (production settings) ──────────────────────────────────────────

  db:
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:${POSTGRES_PORT:-5432}"

  kong:
    restart: unless-stopped

  auth:
    restart: unless-stopped

  rest:
    restart: unless-stopped

  studio:
    restart: unless-stopped

  meta:
    restart: unless-stopped

  # ─── Manifold Services (containerized for production) ────────────────────────

  manifold-api:
    image: ghcr.io/globalstrategic/manifold-api:latest
    build:
      context: .
      dockerfile: manifold-api.Dockerfile
    container_name: manifold-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      kong:
        condition: service_started
    ports:
      - "8088:80"
    environment:
      SELF_HOSTED: "true"
      PORT: "80"
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      SUPABASE_DB_HOST: db
      SUPABASE_DB_PORT: ${POSTGRES_PORT:-5432}
      SUPABASE_PASSWORD: ${POSTGRES_PASSWORD}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_URL: http://kong:8000
      SUPABASE_JWT_SECRET: ${JWT_SECRET}
      SUPABASE_INSTANCE_ID: self-hosted
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      NEXT_PUBLIC_FIREBASE_ENV: ${NEXT_PUBLIC_FIREBASE_ENV:-PROD}
      API_SECRET: ${API_SECRET:-self-hosted-api-secret}
      DOMAIN: ${DOMAIN:-localhost}
      API_ENDPOINT: ${API_ENDPOINT:-localhost:8088}
      FIREBASE_API_KEY: ${FIREBASE_API_KEY}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
      FIREBASE_MESSAGING_SENDER_ID: ${FIREBASE_MESSAGING_SENDER_ID}
      FIREBASE_APP_ID: ${FIREBASE_APP_ID}

  manifold-web:
    image: ghcr.io/globalstrategic/manifold-web:latest
    build:
      context: .
      dockerfile: manifold-web.Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-http://localhost:8000}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
    container_name: manifold-web
    restart: unless-stopped
    depends_on:
      manifold-api:
        condition: service_started
    ports:
      - "3000:3000"
    environment:
      SELF_HOSTED: "true"
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}

  manifold-scheduler:
    image: ghcr.io/globalstrategic/manifold-api:latest
    build:
      context: .
      dockerfile: manifold-api.Dockerfile
    container_name: manifold-scheduler
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      SELF_HOSTED: "true"
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      SUPABASE_DB_HOST: db
      SUPABASE_DB_PORT: ${POSTGRES_PORT:-5432}
      SUPABASE_PASSWORD: ${POSTGRES_PASSWORD}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_URL: http://kong:8000
      SUPABASE_JWT_SECRET: ${JWT_SECRET}
      SUPABASE_INSTANCE_ID: self-hosted
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      NEXT_PUBLIC_FIREBASE_ENV: ${NEXT_PUBLIC_FIREBASE_ENV:-PROD}
      API_SECRET: ${API_SECRET:-self-hosted-api-secret}
      DOMAIN: ${DOMAIN:-localhost}
      API_ENDPOINT: ${API_ENDPOINT:-localhost:8088}
      FIREBASE_API_KEY: ${FIREBASE_API_KEY}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
      FIREBASE_MESSAGING_SENDER_ID: ${FIREBASE_MESSAGING_SENDER_ID}
      FIREBASE_APP_ID: ${FIREBASE_APP_ID}
    command: ["node", "backend/scheduler/lib/index.js"]

  # ─── Nginx Reverse Proxy ────────────────────────────────────────────────────

  nginx:
    image: nginx:alpine
    container_name: manifold-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl/origin:ro
    depends_on:
      - manifold-web
      - manifold-api
      - kong
      - studio
